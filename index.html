<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="origin">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>ì œíœ´ì—…ì²´ ì°¾ê¸° - íŒŒíŠ¸ë„ˆ ì§€ë„</title>
  
  <!-- ë„¤ì´ë²„ ì§€ë„ API: ë°œê¸‰ë°›ì€ Client IDë¡œ êµì²´í•˜ì„¸ìš” -->
  <script>
    // ë„¤ì´ë²„ ì§€ë„ API ë™ì  ë¡œë“œ
    (function() {
      var script = document.createElement('script');
      script.type = 'text/javascript';
      script.src = 'https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=bfp8odep5r&t=' + Date.now();
      script.async = true;
      script.onerror = function() {
        console.error('âŒ ë„¤ì´ë²„ ì§€ë„ API ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨');
        window.naverMapLoadError = true;
      };
      script.onload = function() {
        console.log('âœ… ë„¤ì´ë²„ ì§€ë„ API ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
        window.naverMapLoaded = true;
        // ì§€ë„ ì´ˆê¸°í™”ê°€ ëŒ€ê¸° ì¤‘ì´ë©´ ì‹¤í–‰
        if (window.pendingMapInit) {
          window.pendingMapInit();
        }
      };
      document.head.appendChild(script);
    })();
  </script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', 'Segoe UI', sans-serif; 
      font-size: 16px; 
      line-height: 1.7; 
      color: #2C2C2C; 
      background-color: #F9F8F5; 
    }
    
    /* í—¤ë” */
    .page-header { 
      background: linear-gradient(135deg, #7B8E7E 0%, #5A6B5D 100%); 
      color: white; 
      padding: 48px 20px; 
      text-align: center; 
    }
    
    .page-title { 
      font-size: 28px; 
      font-weight: bold; 
      margin-bottom: 12px; 
    }
    
    .page-subtitle { 
      font-size: 16px; 
      opacity: 0.95; 
    }
    
    /* ìƒíƒœ ì•Œë¦¼ */
    .status-notice { 
      border-radius: 12px; 
      padding: 20px; 
      margin: 20px auto; 
      max-width: 1280px; 
      text-align: center; 
      display: none;
    }
    
    .status-notice h3 { 
      margin-bottom: 10px; 
      font-size: 18px; 
    }
    
    .status-notice p { 
      font-size: 14px; 
      line-height: 1.6; 
    }
    
    .status-loading { 
      background-color: #E3F2FD; 
      border: 2px solid #2196F3; 
      display: block;
    }
    
    .status-loading h3 { 
      color: #1976D2; 
    }
    
    .status-error { 
      background-color: #FFEBEE; 
      border: 2px solid #F44336; 
    }
    
    .status-error h3 { 
      color: #D32F2D; 
    }
    
    .status-error .error-details { 
      margin-top: 12px; 
      padding: 12px; 
      background-color: #FFCDD2; 
      border-radius: 6px; 
      font-family: monospace; 
      font-size: 12px; 
      text-align: left; 
    }
    
    /* ì§€ë„ ì»¨í…Œì´ë„ˆ */
    .map-container { 
      position: relative; 
      width: 100%; 
      height: 600px; 
      background-color: #E5E3DC; 
      margin: 20px auto;
      max-width: 1280px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    
    #map { 
      width: 100%; 
      height: 100%; 
    }
    
    .map-loading { 
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      text-align: center; 
      color: #666; 
      font-size: 16px; 
      z-index: 1000; 
      background-color: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .map-loading.hidden { 
      display: none; 
    }
    
    /* InfoWindow ìŠ¤íƒ€ì¼ */
    .custom-infowindow {
      background-color: white;
      border-radius: 16px;
      padding: 0;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      min-width: 280px;
      max-width: 320px;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', sans-serif;
    }
    
    .info-image-container {
      width: 100%;
      height: 180px;
      overflow: hidden;
      background: linear-gradient(135deg, #F5F5F5 0%, #E0E0E0 100%);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .info-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .info-image:not([src]),
    .info-image[src=""] {
      display: none;
    }
    
    .info-image-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      font-size: 48px;
    }
    
    .info-content {
      padding: 16px;
    }
    
    .info-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    
    .info-name {
      font-size: 18px;
      font-weight: 700;
      color: #2C2C2C;
      margin: 0;
      line-height: 1.4;
      flex: 1;
    }
    
    .info-badge {
      display: inline-block;
      background: linear-gradient(135deg, #7B8E7E, #5A6B5D);
      color: white;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
      white-space: nowrap;
    }
    
    .info-description {
      font-size: 14px;
      color: #666;
      line-height: 1.6;
      margin-bottom: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .info-details {
      font-size: 13px;
      color: #888;
      margin-bottom: 12px;
      padding-top: 12px;
      border-top: 1px solid #F0F0F0;
    }
    
    .info-detail-item {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }
    
    .info-detail-item:last-child {
      margin-bottom: 0;
    }
    
    .info-detail-icon {
      margin-right: 8px;
      font-size: 14px;
      width: 20px;
      text-align: center;
    }
    
    .info-detail-text {
      flex: 1;
    }
    
    .info-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .info-btn {
      flex: 1;
      padding: 10px 16px;
      background-color: #7B8E7E;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      text-decoration: none;
      display: inline-block;
    }
    
    .info-btn:hover {
      background-color: #5A6B5D;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .info-btn.secondary {
      background-color: #F5F5F5;
      color: #666;
      border: 1px solid #E0E0E0;
    }
    
    .info-btn.secondary:hover {
      background-color: #E8E8E8;
      color: #333;
    }
    
    /* ë°˜ì‘í˜• ë””ìì¸ */
    @media (max-width: 768px) {
      .page-title { 
        font-size: 24px; 
      }
      
      .page-subtitle { 
        font-size: 14px; 
      }
      
      .map-container { 
        height: 500px; 
        margin: 10px;
        border-radius: 8px;
      }
      
      .custom-infowindow {
        min-width: 260px;
        max-width: 280px;
      }
      
      .info-image-container {
        height: 150px;
      }
      
      .info-name {
        font-size: 16px;
      }
      
      .info-content {
        padding: 14px;
      }
      
      .info-actions {
        flex-direction: column;
      }
      
      .info-btn {
        width: 100%;
      }
    }
    
    @media (max-width: 480px) {
      .custom-infowindow {
        min-width: 240px;
        max-width: 260px;
      }
      
      .info-image-container {
        height: 120px;
      }
    }
  </style>
</head>
<body>
  
  <div class="page-header">
    <h1 class="page-title">ğŸ—ºï¸ ì œíœ´ì—…ì²´ ì°¾ê¸°</h1>
    <p class="page-subtitle">ì „êµ­ ì œíœ´ì—…ì²´ ìœ„ì¹˜ë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
  </div>
  
  <div id="status-notice" class="status-notice status-loading">
    <h3>ğŸ“Š ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</h3>
    <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
  </div>
  
  <div class="map-container">
    <div id="map"></div>
    <div class="map-loading" id="map-loading">
      <div style="font-size: 48px; margin-bottom: 16px;">ğŸ—ºï¸</div>
      <div>ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
  </div>
  
  <script>
    // ========================================
    // ğŸ”§ ì„¤ì •: ì—¬ê¸°ë§Œ ìˆ˜ì •í•˜ì„¸ìš”!
    // ========================================
    
    // Google Apps Script ì›¹ ì•± URL
    var GOOGLE_SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbwt7dbyxGoVcwcdFtjThfgJEoHFBIAINLXnrPj3cwRVR2kXAP95TXb9MbcTzXoxCULB2g/exec';
    //                          â†‘â†‘â†‘ ì—¬ê¸°ì— ë°œê¸‰ë°›ì€ URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”
    
    // ë””ë²„ê·¸ ëª¨ë“œ (trueë¡œ ì„¤ì •í•˜ë©´ ì½˜ì†”ì— ìƒì„¸ ë¡œê·¸ ì¶œë ¥)
    var DEBUG_MODE = true;
    
    // ========================================
    // ì „ì—­ ë³€ìˆ˜
    // ========================================
    var partnersData = [];
    var map = null;
    var markers = [];
    var infowindows = [];
    
    // ========================================
    // ìœ í‹¸ë¦¬í‹°: ë¡œê¹…
    // ========================================
    function debugLog(message, data) {
      if (DEBUG_MODE) {
        console.log('[ì œíœ´ì—…ì²´ì§€ë„]', message, data || '');
      }
    }
    
    // ========================================
    // ìƒíƒœ í‘œì‹œ
    // ========================================
    function showStatus(type, title, message, details) {
      var notice = document.getElementById('status-notice');
      if (!notice) return;
      
      notice.className = 'status-notice status-' + type;
      
      var html = '<h3>' + title + '</h3><p>' + message + '</p>';
      
      if (details && type === 'error') {
        html += '<div class="error-details"><strong>ìƒì„¸ ì •ë³´:</strong><br>' + details + '</div>';
      }
      
      notice.innerHTML = html;
      notice.style.display = 'block';
    }
    
    function hideStatus() {
      var notice = document.getElementById('status-notice');
      if (notice) {
        notice.style.display = 'none';
      }
    }
    
    // ========================================
    // êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì´ë¯¸ì§€ URL ë³€í™˜
    // ========================================
    function convertGoogleDriveUrl(url) {
      if (!url || url.trim() === '') {
        return null;
      }
      
      var trimmedUrl = url.trim();
      
      // ì´ë¯¸ ì§ì ‘ ì ‘ê·¼ ê°€ëŠ¥í•œ URLì¸ ê²½ìš° (ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° URL)
      if (trimmedUrl.includes('drive.google.com/uc?') || trimmedUrl.includes('lh3.googleusercontent.com')) {
        return trimmedUrl;
      }
      
      // êµ¬ê¸€ ë“œë¼ì´ë¸Œ ê³µìœ  ë§í¬ì—ì„œ íŒŒì¼ ID ì¶”ì¶œ
      // í˜•ì‹: https://drive.google.com/file/d/FILE_ID/view
      // ë˜ëŠ”: https://drive.google.com/open?id=FILE_ID
      var fileId = null;
      
      var match1 = trimmedUrl.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
      if (match1) {
        fileId = match1[1];
      } else {
        var match2 = trimmedUrl.match(/[?&]id=([a-zA-Z0-9_-]+)/);
        if (match2) {
          fileId = match2[1];
        }
      }
      
      if (fileId) {
        // ì¸ë„¤ì¼ ì´ë¯¸ì§€ URL ìƒì„± (ìµœëŒ€ 800px ë„ˆë¹„)
        return 'https://drive.google.com/uc?export=view&id=' + fileId;
      }
      
      // íŒŒì¼ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìœ¼ë©´ ì›ë³¸ URL ë°˜í™˜
      return trimmedUrl;
    }
    
    // ========================================
    // ë°ì´í„° ë¡œë“œ
    // ========================================
    function loadPartnersData() {
      debugLog('ë°ì´í„° ë¡œë“œ ì‹œì‘', GOOGLE_SHEET_API_URL);
      
      showStatus('loading', 'ğŸ“Š ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...', 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
      
      fetch(GOOGLE_SHEET_API_URL)
        .then(function(response) {
          debugLog('ì‘ë‹µ ìˆ˜ì‹ :', {
            status: response.status,
            ok: response.ok
          });
          
          if (!response.ok) {
            throw new Error('API ì‘ë‹µ ì˜¤ë¥˜ (HTTP ' + response.status + ')');
          }
          
          return response.json();
        })
        .then(function(data) {
          debugLog('ë°ì´í„° íŒŒì‹± ì™„ë£Œ:', data);
          
          // ì—ëŸ¬ ì‘ë‹µ ì²´í¬
          if (data.error || data.success === false) {
            throw new Error(data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
          
          // ë°ì´í„° êµ¬ì¡° í™•ì¸
          if (!data.partners || !Array.isArray(data.partners)) {
            throw new Error('ì˜ëª»ëœ ë°ì´í„° í˜•ì‹: partners ë°°ì—´ì´ ì—†ìŠµë‹ˆë‹¤.');
          }
          
          if (data.partners.length === 0) {
            showStatus('error', 
              'âš ï¸ í‘œì‹œí•  ì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤',
              'êµ¬ê¸€ ì‹œíŠ¸ì— ì‹¬ì‚¬ìƒíƒœê°€ "ìŠ¹ì¸"ì´ê³  ìœ„ë„/ê²½ë„ê°€ ì…ë ¥ëœ ì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤.',
              'ê´€ë¦¬ìê°€ ì—…ì²´ë¥¼ ìŠ¹ì¸í•˜ê³  ì£¼ì†Œê°€ ìë™ìœ¼ë¡œ ì¢Œí‘œë¡œ ë³€í™˜ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.'
            );
            return;
          }
          
          partnersData = data.partners;
          
          // ìƒíƒœ ìˆ¨ê¹€
          hideStatus();
          
          // ì§€ë„ì— ë§ˆì»¤ ìƒì„±
          if (map) {
            createMarkers();
          }
          
          debugLog('ë¡œë“œ ì™„ë£Œ:', partnersData.length + 'ê°œ ì—…ì²´');
        })
        .catch(function(error) {
          console.error('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
          
          var errorMsg = error.message || error.toString();
          var helpMsg = '';
          
          // ì—ëŸ¬ ìœ í˜•ë³„ ë„ì›€ë§
          if (errorMsg.indexOf('Failed to fetch') > -1 || errorMsg.indexOf('NetworkError') > -1) {
            helpMsg = 'URLì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”: ' + GOOGLE_SHEET_API_URL;
          } else if (errorMsg.indexOf('Unauthorized') > -1) {
            helpMsg = 'Apps Script ë°°í¬ ì„¤ì •ì—ì„œ "ì•¡ì„¸ìŠ¤ ê¶Œí•œ"ì„ "ëª¨ë“  ì‚¬ìš©ì"ë¡œ ì„¤ì •í•˜ì„¸ìš”.';
          }
          
          showStatus('error',
            'âš ï¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
            errorMsg,
            helpMsg + '<br><br>F12 í‚¤ë¥¼ ëˆŒëŸ¬ ê°œë°œì ë„êµ¬ì˜ Console íƒ­ì—ì„œ ë” ìì„¸í•œ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
          );
        });
    }
    
    // ========================================
    // ì§€ë„ ì´ˆê¸°í™”
    // ========================================
    function initMap() {
      try {
        document.getElementById('map-loading').classList.add('hidden');
        
        var mapOptions = {
          center: new naver.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ì‹œì²­ ê¸°ë³¸ ì¤‘ì‹¬
          zoom: 11,
          zoomControl: true,
          zoomControlOptions: { 
            position: naver.maps.Position.TOP_RIGHT 
          },
          mapTypeControl: true
        };
        
        map = new naver.maps.Map('map', mapOptions);
        
        debugLog('ì§€ë„ ì´ˆê¸°í™” ì„±ê³µ');
        
        // ë°ì´í„°ê°€ ì´ë¯¸ ë¡œë“œë˜ì—ˆìœ¼ë©´ ë§ˆì»¤ ìƒì„±
        if (partnersData.length > 0) {
          createMarkers();
        }
      } catch (error) {
        console.error('âŒ ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        document.getElementById('map-loading').innerHTML = 
          '<div style="color: #C17B7B;">' +
          '<div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>' +
          '<div>ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>' +
          '<div style="font-size:12px; margin-top:8px;">ë„¤ì´ë²„ ì§€ë„ API Client IDë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”</div>' +
          '</div>';
      }
    }
    
    // ========================================
    // ë§ˆì»¤ ìƒì„±
    // ========================================
    function createMarkers() {
      debugLog('ë§ˆì»¤ ìƒì„± ì‹œì‘');
      
      // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
      markers.forEach(function(item) {
        item.marker.setMap(null);
      });
      markers = [];
      infowindows = [];
      
      var createdCount = 0;
      
      // ë„¤ì´ë²„ ì§€ë„ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì˜¤ë¥˜ í‘œì‹œ
      if (!map || typeof naver === 'undefined' || !naver.maps) {
        console.error('âŒ ë„¤ì´ë²„ ì§€ë„ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        showStatus('error',
          'âš ï¸ ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ ì‹¤íŒ¨',
          'ë„¤ì´ë²„ ì§€ë„ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.',
          'í•´ê²° ë°©ë²•:<br><br>' +
          '1. ë„¤ì´ë²„ í´ë¼ìš°ë“œ í”Œë«í¼ ì½˜ì†” ì ‘ì†<br>' +
          '2. Maps â†’ Application â†’ Web Service URL í™•ì¸<br>' +
          '3. http://localhost ë˜ëŠ” http://localhost:8080 ë“±ë¡ í™•ì¸<br>' +
          '4. ë¸Œë¼ìš°ì € ìºì‹œ ì‚­ì œ (Cmd+Shift+R)<br>' +
          '5. 5~10ë¶„ ëŒ€ê¸° í›„ ì¬ì‹œë„'
        );
        return;
      }
      
      var bounds = new naver.maps.LatLngBounds();
      
      partnersData.forEach(function(partner, index) {
        // ìœ„ë„/ê²½ë„ ê²€ì¦
        if (!partner.lat || !partner.lng || partner.lat === 0 || partner.lng === 0) {
          console.warn('âš ï¸ ì¢Œí‘œ ì—†ìŒ ë˜ëŠ” ì˜ëª»ë¨:', partner.name, '(lat:', partner.lat, ', lng:', partner.lng, ')');
          return;
        }
        
        var position = new naver.maps.LatLng(partner.lat, partner.lng);
        bounds.extend(position);
        
        // ë§ˆì»¤ ìƒì„±
        var marker = new naver.maps.Marker({
          position: position,
          map: map,
          title: partner.name,
          icon: {
            content: '<div style="background-color: #7B8E7E; color: white; padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.2); white-space: nowrap; cursor: pointer; border: 2px solid white;">ğŸ“ ' + partner.name + '</div>',
            anchor: new naver.maps.Point(0, 0)
          }
        });
        
        // InfoWindow HTML ìƒì„±
        var infoContent = createInfoWindowHTML(partner);
        
        var infowindow = new naver.maps.InfoWindow({
          content: infoContent,
          backgroundColor: 'transparent',
          borderWidth: 0,
          disableAnchor: true,
          pixelOffset: new naver.maps.Point(0, -10),
          maxWidth: 320
        });
        
        // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
        naver.maps.Event.addListener(marker, 'click', function() {
          // ë‹¤ë¥¸ InfoWindow ë‹«ê¸°
          infowindows.forEach(function(iw) { 
            iw.close(); 
          });
          
          // í˜„ì¬ InfoWindow ì—´ê¸°
          infowindow.open(map, marker);
          map.panTo(position);
        });
        
        markers.push({ 
          marker: marker, 
          partner: partner, 
          infowindow: infowindow 
        });
        
        infowindows.push(infowindow);
        createdCount++;
      });
      
      // ëª¨ë“  ë§ˆì»¤ê°€ ë³´ì´ë„ë¡ ì§€ë„ ë²”ìœ„ ì¡°ì •
      if (createdCount > 0) {
        map.fitBounds(bounds, { padding: 50 });
      }
      
      debugLog('ë§ˆì»¤ ìƒì„± ì™„ë£Œ:', createdCount + 'ê°œ');
    }
    
    // ========================================
    // InfoWindow HTML ìƒì„±
    // ========================================
    function createInfoWindowHTML(partner) {
      // ì´ë¯¸ì§€ URL ë³€í™˜
      var imageUrl = convertGoogleDriveUrl(partner.imageUrl);
      
      // ì´ë¯¸ì§€ HTML
      var imageHTML = '';
      if (imageUrl) {
        imageHTML = '<div class="info-image-container">' +
                    '<img src="' + escapeHtml(imageUrl) + '" alt="' + escapeHtml(partner.name) + '" class="info-image">' +
                    '</div>';
      } else {
        imageHTML = '<div class="info-image-container">' +
                    '<div class="info-image-placeholder">ğŸ¢</div>' +
                    '</div>';
      }
      
      // ì „ì²´ ì£¼ì†Œ (ë„ë¡œëª… ì£¼ì†Œ + ìƒì„¸ ì£¼ì†Œ)
      var fullAddress = partner.address;
      if (partner.detailAddress && partner.detailAddress.trim() !== '') {
        fullAddress += ' ' + partner.detailAddress;
      }
      
      // ìš´ì˜ì‹œê°„ í‘œì‹œ
      var hoursHTML = '';
      if (partner.hours && partner.hours.trim() !== '') {
        hoursHTML = '<div class="info-detail-item">' +
                    '<span class="info-detail-icon">ğŸ•</span>' +
                    '<span class="info-detail-text">' + escapeHtml(partner.hours) + '</span>' +
                    '</div>';
      }
      
      // ì „í™”ë²ˆí˜¸ ë²„íŠ¼
      var phoneButtonHTML = '';
      if (partner.phone && partner.phone.trim() !== '') {
        phoneButtonHTML = '<a href="tel:' + escapeHtml(partner.phone.replace(/\s/g, '')) + '" class="info-btn secondary">ğŸ“ ì „í™”</a>';
      }
      
      // ë§í¬ ë²„íŠ¼
      var linkButtonHTML = '';
      if (partner.link && partner.link.trim() !== '') {
        linkButtonHTML = '<a href="' + escapeHtml(partner.link) + '" target="_blank" class="info-btn">ğŸ”— ë°©ë¬¸</a>';
      }
      
      var html = '<div class="custom-infowindow">' +
                  imageHTML +
                  '<div class="info-content">' +
                  '<div class="info-header">' +
                  '<h3 class="info-name">' + escapeHtml(partner.name) + '</h3>' +
                  '<span class="info-badge">' + escapeHtml(partner.category || 'ì œíœ´ì—…ì²´') + '</span>' +
                  '</div>';
      
      // í•œ ì¤„ ì†Œê°œ
      if (partner.description && partner.description.trim() !== '') {
        html += '<p class="info-description">' + escapeHtml(partner.description) + '</p>';
      }
      
      html += '<div class="info-details">' +
              '<div class="info-detail-item">' +
              '<span class="info-detail-icon">ğŸ“</span>' +
              '<span class="info-detail-text">' + escapeHtml(fullAddress) + '</span>' +
              '</div>' +
              hoursHTML +
              '</div>' +
              '<div class="info-actions">' +
              phoneButtonHTML +
              linkButtonHTML +
              '</div>' +
              '</div>' +
              '</div>';
      
      return html;
    }
    
    // ========================================
    // HTML ì´ìŠ¤ì¼€ì´í”„
    // ========================================
    function escapeHtml(text) {
      if (!text) return '';
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // ========================================
    // ì§€ë„ ì´ˆê¸°í™” í•¨ìˆ˜ (ëŒ€ê¸° ê°€ëŠ¥)
    // ========================================
    function tryInitMap() {
      if (typeof naver !== 'undefined' && naver.maps) {
        initMap();
        return true;
      }
      return false;
    }
    
    // ========================================
    // ì´ˆê¸°í™”
    // ========================================
    function initializeApp() {
      debugLog('DOM ë¡œë“œ ì™„ë£Œ');
      
      // ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ ëŒ€ê¸° (ìµœëŒ€ 10ì´ˆ)
      var checkCount = 0;
      var maxChecks = 50; // 10ì´ˆ (200ms * 50)
      
      function checkNaverMap() {
        checkCount++;
        
        if (tryInitMap()) {
          debugLog('ì§€ë„ ì´ˆê¸°í™” ì„±ê³µ');
          loadPartnersData();
        } else if (window.naverMapLoadError) {
          // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨
          console.error('âš ï¸ ë„¤ì´ë²„ ì§€ë„ API ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨');
          document.getElementById('map-loading').innerHTML = 
            '<div style="color: #C17B7B;">' +
            '<div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>' +
            '<div>ë„¤ì´ë²„ ì§€ë„ API ë¡œë”© ì‹¤íŒ¨</div>' +
            '<div style="font-size:12px; margin-top:8px;">ë„¤ì´ë²„ í´ë¼ìš°ë“œ ì½˜ì†”ì—ì„œ Web Service URL ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”</div>' +
            '</div>';
          loadPartnersData(); // ë°ì´í„°ëŠ” ë¡œë“œ ì‹œë„
        } else if (checkCount < maxChecks) {
          // ì•„ì§ ë¡œë“œ ì¤‘, ê³„ì† ëŒ€ê¸°
          setTimeout(checkNaverMap, 200);
        } else {
          // íƒ€ì„ì•„ì›ƒ
          console.warn('âš ï¸ ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ íƒ€ì„ì•„ì›ƒ');
          document.getElementById('map-loading').innerHTML = 
            '<div style="color: #C17B7B;">' +
            '<div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>' +
            '<div>ë„¤ì´ë²„ ì§€ë„ API ë¡œë”© íƒ€ì„ì•„ì›ƒ</div>' +
            '<div style="font-size:12px; margin-top:8px;">ë„¤ì´ë²„ í´ë¼ìš°ë“œ ì½˜ì†”ì—ì„œ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”</div>' +
            '</div>';
          loadPartnersData(); // ë°ì´í„°ëŠ” ë¡œë“œ ì‹œë„
        }
      }
      
      // ì§€ë„ API ë¡œë“œ í™•ì¸ ì‹œì‘
      checkNaverMap();
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
  
</body>
</html>

